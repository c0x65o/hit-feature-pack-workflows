# Feature Pack: workflow-core
# A HIT feature pack

name: workflow-core
title: System Workflows
description: Workflow core feature pack

# ─────────────────────────────────────────────────────────────────────────────
# ROUTES - Frontend page routes
# ─────────────────────────────────────────────────────────────────────────────
routes:
  - path: /workflows/runs
    page: WorkflowRunsList
    roles: []
    default_roles_allow: [admin]
    authz: { entity: workflows, verb: read }
  - path: /workflows/runs/[runId]
    page: WorkflowRunDetail
    roles: []
    default_roles_allow: [admin]
    authz: { entity: workflows, verb: read }
  - path: /workflows/gates
    page: WorkflowGates
    roles: [admin]

# ─────────────────────────────────────────────────────────────────────────────
# NAVIGATION - Sidebar/topbar items
# ─────────────────────────────────────────────────────────────────────────────
nav:
  - id: workflows
    label: Workflows
    path: /workflows/runs
    icon: Workflow
    group: system
    weight: 900
    showWhen: authenticated
    roles: [admin]
    children:
      - id: workflows-runs
        label: Runs
        path: /workflows/runs
        icon: Activity
        weight: 100
        showWhen: authenticated
        roles: [admin]
      - id: workflows-gates
        label: Gates
        path: /workflows/gates
        icon: Settings
        weight: 110
        showWhen: authenticated
        roles: [admin]

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/workflows.ts
  exports:
    - principalTypeEnum
    - workflows
    - workflowVersions
    - workflowAcls
    - workflowRuns
    - workflowRunEvents
    - workflowTasks
    - WORKFLOW_PERMISSIONS
    - WorkflowPermission
    - Workflow
    - InsertWorkflow
    - WorkflowVersion
    - InsertWorkflowVersion
    - WorkflowAcl
    - InsertWorkflowAcl
    - WorkflowRun
    - InsertWorkflowRun
    - WorkflowRunEvent
    - InsertWorkflowRunEvent
    - WorkflowTask
    - InsertWorkflowTask

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    - path: /api/workflows
      methods: [GET, POST]
      handler: "@hit/feature-pack-workflow-core/server/api/workflows"
      description: "List workflows (GET) or create workflow (POST)"
    - path: /api/workflows/[id]
      methods: [GET, PUT]
      handler: "@hit/feature-pack-workflow-core/server/api/workflows-id"
      description: "Get or update a workflow (includes current draft version)"
    - path: /api/workflows/[id]/publish
      methods: [POST]
      handler: "@hit/feature-pack-workflow-core/server/api/workflows-id-publish"
      description: "Publish a new immutable version from the current draft"
    - path: /api/workflows/[id]/acl
      methods: [GET, POST]
      handler: "@hit/feature-pack-workflow-core/server/api/workflows-id-acl"
      description: "List (GET) or create (POST) ACL entries for a workflow"
    - path: /api/workflows/[id]/acl/[aclId]
      methods: [DELETE]
      handler: "@hit/feature-pack-workflow-core/server/api/workflows-id-acl-id"
      description: "Delete a workflow ACL entry"

    # Runs
    - path: /api/workflows/[id]/runs
      methods: [GET, POST]
      handler: "@hit/feature-pack-workflow-core/server/api/workflows-id-runs"
      description: "List runs for a workflow (GET) or start a new run (POST)"
    - path: /api/workflows/runs/[runId]
      methods: [GET]
      handler: "@hit/feature-pack-workflow-core/server/api/workflow-runs-id"
      description: "Get run detail"
    - path: /api/workflows/runs/[runId]/events
      methods: [GET]
      handler: "@hit/feature-pack-workflow-core/server/api/workflow-runs-id-events"
      description: "Get run event timeline"

    # Tasks (human steps)
    - path: /api/workflows/runs/[runId]/tasks
      methods: [GET, POST]
      handler: "@hit/feature-pack-workflow-core/server/api/workflow-runs-id-tasks"
      description: "List tasks for a run (GET) or create a task (POST) (internal/MVP)"
    - path: /api/workflows/runs/[runId]/tasks/[taskId]/approve
      methods: [POST]
      handler: "@hit/feature-pack-workflow-core/server/api/workflow-runs-id-tasks-id-approve"
      description: "Approve a task and resume run"
    - path: /api/workflows/runs/[runId]/tasks/[taskId]/deny
      methods: [POST]
      handler: "@hit/feature-pack-workflow-core/server/api/workflow-runs-id-tasks-id-deny"
      description: "Deny a task and resume run"

    # Global task inbox (for notification feeds / approvals)
    - path: /api/workflows/tasks
      methods: [GET]
      handler: "@hit/feature-pack-workflow-core/server/api/workflows-tasks"
      description: "List workflow tasks assigned to the current user (open + optionally recently resolved)"

    # Gate config (system-level lifecycle gatekeeper configuration)
    - path: /api/workflows/gates/crm-convert-prospect
      methods: [GET, PUT]
      handler: "@hit/feature-pack-workflow-core/server/api/workflow-gates-crm-convert-prospect"
      description: "Get or update the gatekeeper ACL for CRM prospect->company conversion"

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Action definitions (for admin-core permissions UI + runtime checks)
# ─────────────────────────────────────────────────────────────────────────────
permissions:
  actions:
    # Scope Policy Tree: workflow-core (global) -> entity overrides.
    #
    # Scope modes:
    # - none: deny all access for this verb/entity (hide pages + block APIs)
    # - any: ignore scope (read everything)
    # - own: only owned records (workflow.ownerUserId === current user sub)
    # - ldd: owner OR matching L/D/D (workflows don't have LDD fields yet, so ldd behaves like own)
    #
    # These are mutually exclusive per node; the Security Groups UI renders them as dropdowns.
    - key: workflow-core.read.scope.none
      label: "Workflow-Core Read Scope = None"
      description: "Deny all workflow read access."
      default_enabled: false
    - key: workflow-core.read.scope.any
      label: "Workflow-Core Read Scope = Any"
      description: "Read all workflows regardless of ownership."
      default_enabled: false
    - key: workflow-core.read.scope.own
      label: "Workflow-Core Read Scope = Own"
      description: "Read only workflows you own."
      default_enabled: false
    - key: workflow-core.read.scope.ldd
      label: "Workflow-Core Read Scope = LDD"
      description: "Read workflows you own, or that match your L/D/D scope (currently behaves like own)."
      default_enabled: false

    - key: workflow-core.write.scope.none
      label: "Workflow-Core Write Scope = None"
      description: "Deny all workflow write access."
      default_enabled: false
    - key: workflow-core.write.scope.any
      label: "Workflow-Core Write Scope = Any"
      description: "Edit workflows regardless of ownership."
      default_enabled: false
    - key: workflow-core.write.scope.own
      label: "Workflow-Core Write Scope = Own"
      description: "Edit only workflows you own."
      default_enabled: false
    - key: workflow-core.write.scope.ldd
      label: "Workflow-Core Write Scope = LDD"
      description: "Edit workflows you own, or that match your L/D/D scope (currently behaves like own)."
      default_enabled: false

    # Workflows override (optional): if set, overrides workflow-core.read.scope.* for workflows only.
    - key: workflow-core.workflows.read.scope.none
      label: "Workflow-Core Workflows Read Scope = None"
      description: "Deny all workflow read access."
      default_enabled: false
    - key: workflow-core.workflows.read.scope.any
      label: "Workflow-Core Workflows Read Scope = Any"
      description: "Read workflows regardless of ownership."
      default_enabled: false
    - key: workflow-core.workflows.read.scope.own
      label: "Workflow-Core Workflows Read Scope = Own"
      description: "Read only workflows you own."
      default_enabled: false
    - key: workflow-core.workflows.read.scope.ldd
      label: "Workflow-Core Workflows Read Scope = LDD"
      description: "Read workflows you own, or that match your L/D/D scope (currently behaves like own)."
      default_enabled: false

    - key: workflow-core.workflows.write.scope.none
      label: "Workflow-Core Workflows Write Scope = None"
      description: "Deny all workflow write access."
      default_enabled: false
    - key: workflow-core.workflows.write.scope.any
      label: "Workflow-Core Workflows Write Scope = Any"
      description: "Edit workflows regardless of ownership."
      default_enabled: false
    - key: workflow-core.workflows.write.scope.own
      label: "Workflow-Core Workflows Write Scope = Own"
      description: "Edit only workflows you own."
      default_enabled: false
    - key: workflow-core.workflows.write.scope.ldd
      label: "Workflow-Core Workflows Write Scope = LDD"
      description: "Edit workflows you own, or that match your L/D/D scope (currently behaves like own)."
      default_enabled: false

    - key: workflow-core.workflows.create
      label: Create Workflow
      description: "Create a new workflow."
      default_enabled: false

# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
requires:
  modules: []

dependencies:
  feature_packs:
    - name: erp-shell-core
